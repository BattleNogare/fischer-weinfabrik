<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fischer Weinfabrik Â· AuftrÃ¤ge</title>
  <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/BattleNogare/h-h_weinfabrik/main/fischer_weinfabrik_logo.png">

  <style>
    :root{
      --bg:#0b0d10;
      --bg2:#0f1217;
      --card:#11151c;
      --card2:#0f131a;
      --text:#e7eaf0;
      --muted:#a8b0bf;
      --border: rgba(255,255,255,.08);
      --shadow: 0 12px 34px rgba(0,0,0,.42);
      --accent:#e11d48;
      --focus: 0 0 0 3px rgba(225,29,72,.25);
      --radius: 14px;
    }

    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(225,29,72,.20), transparent 55%),
        radial-gradient(900px 500px at 80% 20%, rgba(225,29,72,.10), transparent 50%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      color: var(--text);
    }

    .app{ width:85%; max-width:1300px; margin:22px auto 40px; }

    .topbar{
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      padding:14px 16px;
      background: color-mix(in srgb, var(--card) 92%, transparent);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      position: sticky; top: 14px; backdrop-filter: blur(10px);
      z-index: 10;
    }

    .brand{ display:flex; gap:12px; align-items:center; min-width: 260px; }
    .brand img{
      width:34px; height:34px; border-radius:10px; border:1px solid var(--border);
      background: var(--card2); padding:5px;
    }
    .brand h2{ margin:0; font-size:18px; line-height:1.1; }
    .brand .sub{ margin:2px 0 0; font-size:12px; color:var(--muted); }

    nav{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center; }
    .tab{
      border:1px solid var(--border);
      background: linear-gradient(180deg, color-mix(in srgb, var(--card) 92%, transparent), var(--card2));
      color:var(--text);
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:700;
      transition: transform .08s ease, border-color .2s ease, background .2s ease;
      display:flex; align-items:center; gap:8px;
    }
    .tab:hover{ transform: translateY(-1px); border-color: color-mix(in srgb, var(--accent) 40%, var(--border)); }
    .tab.active{
      border-color: color-mix(in srgb, var(--accent) 70%, var(--border));
      box-shadow: 0 0 0 4px rgba(225,29,72,.14);
      background: linear-gradient(180deg, rgba(225,29,72,.18), rgba(225,29,72,.10));
    }
    .tab .dot{ width:8px; height:8px; border-radius:999px; background: var(--accent); box-shadow: 0 0 0 3px rgba(225,29,72,.15); }

    .actions{ min-width:260px; display:flex; justify-content:flex-end; gap:10px; align-items:center; }
    .pill{
      border:1px solid var(--border);
      background: color-mix(in srgb, var(--card) 85%, transparent);
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
    }

    .grid{ display:grid; grid-template-columns: 1fr; gap:14px; margin-top:14px; }

    .card{
      border:1px solid var(--border);
      background: linear-gradient(180deg, color-mix(in srgb, var(--card) 94%, transparent), var(--card2));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
      overflow:hidden;
    }
    .card h3{ margin:0 0 12px; font-size:16px; }

    .msg{
      padding: 12px 14px; border-radius: 12px;
      border: 1px solid var(--border);
      background: color-mix(in srgb, var(--card) 90%, transparent);
      display:none;
      margin-top: 14px;
      white-space: pre-line;
    }
    .msg.show{ display:block; }
    .msg.ok{ border-color: rgba(34,197,94,.35); }
    .msg.error{ border-color: rgba(239,68,68,.40); }

    .muted{ color:var(--muted); font-size:.92em; }
    .hidden{ display:none !important; }

    .form{ display:grid; grid-template-columns: 1fr; gap:12px; }

    label{ display:block; font-weight: 800; font-size: 13px; }
    input, textarea, select{
      width:100%;
      margin-top:6px;
      padding:10px 11px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: color-mix(in srgb, var(--bg) 35%, var(--card));
      color: var(--text);
      outline:none;
      transition: box-shadow .2s ease, border-color .2s ease;
      box-sizing:border-box;
    }
    textarea{ resize: vertical; min-height: 90px; }
    input:focus, textarea:focus, select:focus{
      box-shadow: var(--focus);
      border-color: color-mix(in srgb, var(--accent) 55%, var(--border));
    }
    input[readonly]{ opacity:.92; cursor:not-allowed; }

    .toolbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:12px; }
    .toolbar input{ max-width:340px; }
    .pager{ display:flex; gap:8px; align-items:center; margin-left:auto; }

    .btn{
      border:1px solid var(--border);
      background: linear-gradient(180deg, color-mix(in srgb, var(--card) 92%, transparent), var(--card2));
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:750;
      transition: transform .08s ease, border-color .2s ease;
      display:inline-flex; align-items:center; gap:8px;
    }
    .btn:hover{ transform: translateY(-1px); border-color: color-mix(in srgb, var(--accent) 40%, var(--border)); }
    .btn:disabled{ opacity:.6; cursor:not-allowed; transform:none; }
    .btn-primary{
      border-color: color-mix(in srgb, var(--accent) 60%, var(--border));
      background: linear-gradient(180deg, rgba(225,29,72,.35), rgba(225,29,72,.15));
    }
    .btn-danger{
      border-color: rgba(239,68,68,.55);
      background: linear-gradient(180deg, rgba(239,68,68,.22), rgba(239,68,68,.12));
    }
    .tiny{ padding: 8px 10px; border-radius: 10px; font-weight: 750; }

    .table-wrap{
      border:1px solid var(--border);
      border-radius: 12px;
      overflow:auto;
      max-height: 70vh;
      background: color-mix(in srgb, var(--card) 85%, transparent);
    }
    table{ width:100%; border-collapse: separate; border-spacing: 0; min-width: 900px; }
    thead th{
      position: sticky;
      top: 0;
      z-index: 3;
      font-size:12px; text-transform: uppercase; letter-spacing:.2px;
      color: var(--muted);
      background: color-mix(in srgb, var(--card) 92%, black);
      border-bottom: 1px solid var(--border);
      padding: 10px 10px;
      white-space: nowrap;
    }
    tbody td{ border-bottom: 1px solid var(--border); padding: 10px 10px; vertical-align: top; }
    tbody tr:hover td{ background: rgba(225,29,72,.06); }

    iframe#sinkFrame{ display:none; width:0; height:0; border:0; }
    .date-cell input[type="date"]{ padding:8px 10px; border-radius:10px; }

    @media (max-width: 920px){
      .app{ width:94%; }
      .pager{ margin-left: 0; }
      .actions{ min-width:auto; }
      .brand{ min-width:auto; }
      table{ min-width: 860px; }
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <img alt="Logo" src="https://raw.githubusercontent.com/BattleNogare/h-h_weinfabrik/main/fischer_weinfabrik_logo.png">
        <div>
          <h2>AuftrÃ¤ge</h2>
          <p class="sub">LIVE Read: Google Sheets GVIZ JSONP Â· Write: Apps Script</p>
        </div>
      </div>

      <nav>
        <button id="tab-create" class="tab active"><span class="dot"></span>Auftrag erstellen</button>
        <button id="tab-open" class="tab"><span class="dot"></span>Offene AuftrÃ¤ge</button>
        <button id="tab-done" class="tab"><span class="dot"></span>Fertige AuftrÃ¤ge</button>
      </nav>

      <div class="actions">
        <span id="syncPill" class="pill">Sync: â€“</span>
        <button id="btnReload" class="btn tiny">â†» Neu laden</button>
        <span class="pill">Sortierung: ID â†‘</span>
      </div>
    </div>

    <div id="msg" class="msg"></div>

    <div class="grid">
      <section id="view-create" class="card">
        <h3>Auftrag erstellen</h3>

        <div class="form">
          <div><label>Kunde*<input id="fKunde" type="text" required /></label></div>
          <div><label>Mitarbeiter*<input id="fMitarbeiter" type="text" required /></label></div>
          <div><label>Anzahl FÃ¤sser*<input id="fAnzahl" type="number" min="0" step="1" required /></label></div>
          <div><label>Prozent* (1â€“100)<input id="fProzent" type="number" min="1" max="100" step="1" required /></label></div>
          <div><label>Kosten (automatisch)<input id="fKosten" type="text" readonly /></label></div>

          <div>
            <label>Kunde hat alle Weinflaschen erhalten?
              <select id="fErhalten" disabled>
                <option value="false" selected>Nein</option>
                <option value="true">Ja</option>
              </select>
            </label>
            <div class="muted">Neue AuftrÃ¤ge werden immer als â€žNeinâ€œ gespeichert.</div>
          </div>

          <div><label>Info<textarea id="fInfo" rows="3"></textarea></label></div>
        </div>

        <div style="margin-top: 14px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <button id="btnCreate" class="btn btn-primary">ðŸ’¾ Speichern</button>
          <span class="muted">* Pflichtfelder</span>
        </div>

        <div class="muted" style="margin-top:10px;">
          Hinweis: Lesen ist â€žliveâ€œ aus der Tabelle (GViz). Schreiben geht per Apps Script (Form POST).
        </div>
      </section>

      <section id="view-open" class="card hidden">
        <h3>Offene AuftrÃ¤ge</h3>

        <div class="toolbar">
          <input id="openSearch" type="text" placeholder="Suche Kunde/Mitarbeiterâ€¦" />
          <div class="pager">
            <button id="openPrev" class="btn tiny">â—€</button>
            <span id="openPageInfo" class="pill"></span>
            <button id="openNext" class="btn tiny">â–¶</button>
          </div>
        </div>

        <div id="openTableWrap"></div>
      </section>

      <section id="view-done" class="card hidden">
        <h3>Fertige AuftrÃ¤ge</h3>

        <div class="toolbar">
          <input id="doneSearch" type="text" placeholder="Suche Kunde/Mitarbeiterâ€¦" />
          <div class="pager">
            <button id="donePrev" class="btn tiny">â—€</button>
            <span id="donePageInfo" class="pill"></span>
            <button id="doneNext" class="btn tiny">â–¶</button>
          </div>
        </div>

        <div id="doneTableWrap"></div>
      </section>
    </div>
  </div>

  <iframe id="sinkFrame" name="sinkFrame"></iframe>

<script>
/** =========================
 * CONFIG
 * ========================= */
const WEBAPP_EXEC_URL = 'https://script.google.com/macros/s/AKfycbwdmRIAvTa05Rty0E5E9zintH15VerIP5dPgvOzD4Ymk77mCyuE0IPqzrX3XGzNmNHoyg/exec';
const API_BASE = WEBAPP_EXEC_URL + '?api=1';

// Google Sheet config (READ via GViz JSONP)
const SPREADSHEET_ID = '18Q64WpaE2NAEmva0Y8dABSamcMfzcbVp2CJ1ToZ9Il8';
const SHEET_GID = '345717060'; // <- das ist dein GID aus der alten CSV URL

const PAGE_SIZE = 50;
const DEBUG = true;

/** =========================
 * Helpers
 * ========================= */
const $ = (id) => document.getElementById(id);
function log(...args){ if (DEBUG) console.log('[GH-GVIZ]', ...args); }

function showMsg(type, text) {
  const el = $('msg');
  el.className = 'msg show ' + (type === 'error' ? 'error' : 'ok');
  el.textContent = text;
  clearTimeout(showMsg._t);
  showMsg._t = setTimeout(() => { el.className = 'msg'; el.textContent=''; }, 5200);
}

function setTab(tab) {
  const tabs = ['create','open','done'];
  for (const t of tabs) {
    $('tab-' + t).classList.toggle('active', t === tab);
    $('view-' + t).classList.toggle('hidden', t !== tab);
  }

  // âœ… Tab-Wechsel: immer live neu lesen (GViz + cache-bust)
  if (tab === 'open') { loadAllFromGViz(true).then(renderOpen).catch(e => showMsg('error', e.message)); }
  if (tab === 'done') { loadAllFromGViz(true).then(renderDone).catch(e => showMsg('error', e.message)); }
}

function todayISO() {
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd}`;
}
const TODAY_MIN = todayISO();
function isDateBeforeToday(dateStr) {
  if (!dateStr) return false;
  return dateStr < TODAY_MIN;
}

function parseNumberDE(value) {
  if (typeof value === 'number' && Number.isFinite(value)) return value;
  const s = String(value ?? '').trim().replace(/\s/g, '').replace(/â‚¬/g, '');
  if (!s) return 0;
  const normalized = s.replace(/\./g, '').replace(',', '.');
  const n = Number(normalized);
  return Number.isFinite(n) ? n : 0;
}
function toBool(v){
  const s = String(v ?? '').trim().toLowerCase();
  return (s === 'true' || s === '1' || s === 'ja' || s === 'yes');
}
function toInt(v){
  const n = Math.trunc(Number(String(v ?? '').replace(',', '.')));
  return Number.isFinite(n) ? n : 0;
}
function escapeHtml(s) {
  return String(s ?? '')
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#039;');
}
function normalizeDateOnlyForInput(v){
  const s = String(v ?? '').trim();
  if (!s) return '';
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
  const m = s.match(/(\d{4}-\d{2}-\d{2})/);
  if (m) return m[1];
  return '';
}

function computeKosten(anzahl, prozent) {
  const a = Number(anzahl);
  const p = Number(prozent);
  if (!Number.isFinite(a) || !Number.isFinite(p)) return '';
  const val = (a * 8 * 1299) * (p / 100);
  return Math.round(val).toLocaleString('de-DE') + ' â‚¬';
}
function moneyEUR(n) {
  const v = Number(n);
  if (!Number.isFinite(v)) return '';
  return Math.round(v).toLocaleString('de-DE') + ' â‚¬';
}

/** =========================
 * JSONP Loader (generic)
 * ========================= */
function jsonp(url, { timeoutMs = 15000 } = {}) {
  return new Promise((resolve, reject) => {
    const cbName = '__cb_' + Math.random().toString(36).slice(2);
    const script = document.createElement('script');
    const started = Date.now();

    function cleanup() {
      try { delete window[cbName]; } catch {}
      if (script && script.parentNode) script.parentNode.removeChild(script);
    }

    const t = setTimeout(() => {
      cleanup();
      reject(new Error('JSONP Timeout nach ' + timeoutMs + 'ms\nURL: ' + url));
    }, timeoutMs);

    window[cbName] = (data) => {
      clearTimeout(t);
      cleanup();
      resolve(data);
    };

    const u = new URL(url);
    u.searchParams.set('callback', cbName);

    script.async = true;
    script.referrerPolicy = "no-referrer";
    script.src = u.toString();

    log('JSONP SCRIPT SRC:', script.src);

    script.onerror = () => {
      clearTimeout(t);
      cleanup();
      const ms = Date.now() - started;
      reject(new Error('JSONP Script Load Error\nDauer: ' + ms + 'ms\nURL: ' + script.src));
    };

    document.head.appendChild(script);
  });
}

/** =========================
 * LIVE READ via Google Sheets GViz
 * ========================= */
let allRows = [];
let lastSync = null;

// GViz returns: google.visualization.Query.setResponse({...})
// We load it via JSONP-ish "callback=..." and then parse payload.
async function loadAllFromGViz(forceNoCache) {
  const base = `https://docs.google.com/spreadsheets/d/${encodeURIComponent(SPREADSHEET_ID)}/gviz/tq`;
  const u = new URL(base);
  u.searchParams.set('gid', SHEET_GID);
  u.searchParams.set('tqx', 'out:json'); // returns JS wrapper string
  if (forceNoCache) u.searchParams.set('_ts', String(Date.now()));

  // We cannot use fetch reliably cross-origin without CORS;
  // so we do JSONP by loading the endpoint as script and capturing string via callback.
  // Trick: Use the "tqx=out:json" response as a string passed to our callback by requesting
  // docs.google.com via our own JSONP wrapper endpoint? Not possible.
  //
  // Instead: Load GViz with a normal <script> and intercept by defining google.visualization.Query.setResponse.
  // We'll do that safely below.

  const url = u.toString();
  log('GVIZ LOAD', url);

  // Remove previous hook if any
  if (!window.google) window.google = {};
  if (!window.google.visualization) window.google.visualization = {};

  // We'll intercept setResponse once for this load
  const prev = window.google.visualization.Query && window.google.visualization.Query.setResponse;
  let resolveFn, rejectFn;
  const p = new Promise((resolve, reject) => { resolveFn = resolve; rejectFn = reject; });

  const timeout = setTimeout(() => {
    cleanup();
    rejectFn(new Error('GViz Timeout (keine Antwort)\nURL: ' + url));
  }, 15000);

  function cleanup() {
    clearTimeout(timeout);
    // restore previous handler
    if (prev) {
      window.google.visualization.Query.setResponse = prev;
    } else {
      // keep minimal object
      if (window.google && window.google.visualization && window.google.visualization.Query) {
        // noop
      }
    }
  }

  // ensure Query exists
  if (!window.google.visualization.Query) window.google.visualization.Query = {};
  window.google.visualization.Query.setResponse = (resp) => {
    try {
      cleanup();
      resolveFn(resp);
    } catch (e) {
      cleanup();
      rejectFn(e);
    }
  };

  // load script
  const script = document.createElement('script');
  script.async = true;
  script.referrerPolicy = "no-referrer";
  script.src = url;
  script.onerror = () => {
    cleanup();
    rejectFn(new Error('GViz Script Load Error\nURL: ' + url));
  };
  document.head.appendChild(script);

  const resp = await p;

  // Parse rows into objects by column labels
  const table = resp && resp.table;
  if (!table || !table.cols || !table.rows) throw new Error('GViz: ungÃ¼ltige Antwortstruktur');

  const cols = table.cols.map(c => (c && c.label ? String(c.label).trim() : ''));
  const rows = table.rows;

  const items = rows.map(r => {
    const obj = {};
    const cells = r.c || [];
    for (let i = 0; i < cols.length; i++) {
      const key = cols[i];
      if (!key) continue;
      const cell = cells[i];
      // prefer formatted value if present; else raw value
      const v = (cell && cell.v !== undefined) ? cell.v : '';
      const f = (cell && cell.f !== undefined) ? cell.f : undefined;
      obj[key] = (f !== undefined && f !== null && f !== '') ? f : v;
    }
    return obj;
  });

  allRows = items.map(r => {
    r.ID = toInt(r.ID);
    r.Anzahl = toInt(r.Anzahl);
    r.Prozent = toInt(r.Prozent);
    r.Kosten = parseNumberDE(r.Kosten);

    r.AuftragsDatum = String(r.AuftragsDatum ?? '').trim();
    r.AbholDatum = String(r.AbholDatum ?? '').trim();
    r.__abholInput = normalizeDateOnlyForInput(r.AbholDatum);

    r.__erhalten = !!r['Kunde hat alle Weinflaschen erhalten?'] || toBool(r['Kunde hat alle Weinflaschen erhalten?']);
    return r;
  }).sort((a,b) => a.ID - b.ID);

  lastSync = new Date();
  $('syncPill').textContent = 'Sync: ' + lastSync.toLocaleString('de-DE');
}

/** =========================
 * WRITE via Apps Script (Form POST no CORS)
 * ========================= */
function postForm(paramsObj, bodyObj) {
  const url = new URL(API_BASE);
  Object.entries(paramsObj || {}).forEach(([k,v]) => url.searchParams.set(k, String(v)));

  const form = document.createElement('form');
  form.method = 'POST';
  form.action = url.toString();
  form.target = 'sinkFrame';
  form.style.display = 'none';

  Object.entries(bodyObj || {}).forEach(([k,v]) => {
    const inp = document.createElement('input');
    inp.type = 'hidden';
    inp.name = k;
    inp.value = String(v);
    form.appendChild(inp);
  });

  document.body.appendChild(form);
  log('POST FORM', form.action, bodyObj);

  form.submit();
  setTimeout(() => form.remove(), 1000);
}

/** =========================
 * Create
 * ========================= */
function validateCreateForm() {
  const kunde = $('fKunde').value.trim();
  const mitarbeiter = $('fMitarbeiter').value.trim();
  const anzahl = toInt($('fAnzahl').value);
  const prozent = toInt($('fProzent').value);

  if (!kunde) throw new Error('Kunde ist Pflichtfeld.');
  if (!mitarbeiter) throw new Error('Mitarbeiter ist Pflichtfeld.');
  if (!Number.isInteger(anzahl) || anzahl < 0) throw new Error('Anzahl muss eine nicht-negative Ganzzahl sein.');
  if (!Number.isInteger(prozent) || prozent < 1 || prozent > 100) throw new Error('Prozent muss 1â€“100 (Ganzzahl) sein.');
}

function hookKostenAuto() {
  const recalc = () => { $('fKosten').value = computeKosten($('fAnzahl').value, $('fProzent').value); };
  $('fAnzahl').addEventListener('input', recalc);
  $('fProzent').addEventListener('input', recalc);
  recalc();
}

async function createOrder() {
  const btn = $('btnCreate');
  btn.disabled = true;
  const old = btn.textContent;
  btn.textContent = 'Speichertâ€¦';

  try {
    validateCreateForm();

    const body = {
      Kunde: $('fKunde').value.trim(),
      Mitarbeiter: $('fMitarbeiter').value.trim(),
      Anzahl: toInt($('fAnzahl').value),
      Prozent: toInt($('fProzent').value),
      Info: $('fInfo').value.trim()
    };

    postForm({ _ts: Date.now() }, body);
    showMsg('ok', 'Auftrag gesendet.\nLade LIVE neuâ€¦');

    $('fKunde').value = '';
    $('fMitarbeiter').value = '';
    $('fAnzahl').value = '';
    $('fProzent').value = '';
    $('fInfo').value = '';
    $('fKosten').value = '';

    // live reload from sheet
    await loadAllFromGViz(true);
    if ($('tab-open').classList.contains('active')) renderOpen();
    if ($('tab-done').classList.contains('active')) renderDone();

  } catch (e) {
    showMsg('error', e.message);
  } finally {
    btn.disabled = false;
    btn.textContent = old;
  }
}

/** =========================
 * Pagination + Search
 * ========================= */
let openState = { page: 1, search: '' };
let doneState = { page: 1, search: '' };

function applySearchAndPage(rows, state) {
  const q = String(state.search || '').trim().toLowerCase();
  let filtered = rows;

  if (q) {
    filtered = rows.filter(r =>
      String(r.Kunde || '').toLowerCase().includes(q) ||
      String(r.Mitarbeiter || '').toLowerCase().includes(q)
    );
  }

  filtered.sort((a,b) => a.ID - b.ID);

  const total = filtered.length;
  const start = (state.page - 1) * PAGE_SIZE;
  const items = filtered.slice(start, start + PAGE_SIZE);

  return { total, items };
}

function renderOpen() {
  const openRows = allRows.filter(r => !r.__erhalten);
  const { total, items } = applySearchAndPage(openRows, openState);

  $('openPageInfo').textContent = `Seite ${openState.page} Â· ${total} Treffer`;
  $('openPrev').disabled = openState.page <= 1;
  $('openNext').disabled = (openState.page * PAGE_SIZE) >= total;

  const wrap = $('openTableWrap');
  if (!items.length) { wrap.innerHTML = '<div class="muted">Keine offenen AuftrÃ¤ge gefunden.</div>'; return; }

  wrap.innerHTML = `
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Kunde</th>
            <th>Mitarbeiter</th>
            <th>Anzahl</th>
            <th>Prozent</th>
            <th>Kosten</th>
            <th>AbholDatum</th>
            <th>Erhalten?</th>
            <th>Info</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          ${items.map(r => `
            <tr>
              <td>${r.ID}</td>
              <td>${escapeHtml(r.Kunde)}</td>
              <td>${escapeHtml(r.Mitarbeiter)}</td>
              <td>${r.Anzahl}</td>
              <td>${r.Prozent}</td>
              <td>${moneyEUR(r.Kosten)}</td>
              <td class="date-cell">
                <input type="date" min="${TODAY_MIN}" data-id="${r.ID}" class="open-abhol" value="${escapeHtml(r.__abholInput || '')}">
              </td>
              <td>
                <select data-id="${r.ID}" class="open-erhalten">
                  <option value="0" selected>Nein</option>
                  <option value="1">Ja</option>
                </select>
                <div class="muted">Ja nur mit AbholDatum</div>
              </td>
              <td><textarea data-id="${r.ID}" class="open-info" rows="2">${escapeHtml(r.Info || '')}</textarea></td>
              <td><button data-id="${r.ID}" class="btn tiny btn-primary open-save">Speichern</button></td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;

  wrap.querySelectorAll('.open-save').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = btn.getAttribute('data-id');
      const info = wrap.querySelector('.open-info[data-id="' + id + '"]').value;
      const erhalten = wrap.querySelector('.open-erhalten[data-id="' + id + '"]').value;
      const abhol = wrap.querySelector('.open-abhol[data-id="' + id + '"]').value;

      if (abhol && isDateBeforeToday(abhol)) {
        showMsg('error', 'AbholDatum darf nicht in der Vergangenheit liegen.');
        return;
      }
      if (erhalten === '1' && !abhol) {
        showMsg('error', 'Bitte zuerst ein AbholDatum auswÃ¤hlen (Pflicht), bevor "Erhalten = Ja" gesetzt wird.');
        return;
      }

      btn.disabled = true;
      const old = btn.textContent;
      btn.textContent = 'Speichertâ€¦';

      try {
        postForm({ method:'PATCH', id, debug:'1', _ts: Date.now() }, { Info: info, Erhalten: erhalten, AbholDatum: abhol });
        showMsg('ok', 'Ã„nderung gesendet. ID: ' + id + '\nLade LIVE neuâ€¦');
        await loadAllFromGViz(true);
        renderOpen();
      } catch (e) {
        showMsg('error', e.message);
      } finally {
        btn.disabled = false;
        btn.textContent = old;
      }
    });
  });
}

function renderDone() {
  const doneRows = allRows.filter(r => r.__erhalten);
  const { total, items } = applySearchAndPage(doneRows, doneState);

  $('donePageInfo').textContent = `Seite ${doneState.page} Â· ${total} Treffer`;
  $('donePrev').disabled = doneState.page <= 1;
  $('doneNext').disabled = (doneState.page * PAGE_SIZE) >= total;

  const wrap = $('doneTableWrap');
  if (!items.length) { wrap.innerHTML = '<div class="muted">Keine fertigen AuftrÃ¤ge gefunden.</div>'; return; }

  wrap.innerHTML = `
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>AuftragsDatum</th>
            <th>Kunde</th>
            <th>Mitarbeiter</th>
            <th>Anzahl</th>
            <th>Prozent</th>
            <th>Kosten</th>
            <th>AbholDatum</th>
            <th>Erhalten?</th>
            <th>Info</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          ${items.map(r => `
            <tr>
              <td>${r.ID}</td>
              <td>${escapeHtml(r.AuftragsDatum || '')}</td>
              <td>${escapeHtml(r.Kunde)}</td>
              <td>${escapeHtml(r.Mitarbeiter)}</td>
              <td>${r.Anzahl}</td>
              <td>${r.Prozent}</td>
              <td>${moneyEUR(r.Kosten)}</td>
              <td>${escapeHtml(r.AbholDatum || '')}</td>
              <td>Ja</td>
              <td>${escapeHtml(r.Info || '')}</td>
              <td><button data-id="${r.ID}" class="btn tiny btn-danger done-del">LÃ¶schen</button></td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;

  wrap.querySelectorAll('.done-del').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = btn.getAttribute('data-id');
      if (!confirm('Auftrag ID ' + id + ' wirklich lÃ¶schen?')) return;

      btn.disabled = true;
      const old = btn.textContent;
      btn.textContent = 'LÃ¶schtâ€¦';

      try {
        postForm({ method:'DELETE', id, debug:'1', _ts: Date.now() }, {});
        showMsg('ok', 'LÃ¶schung gesendet. ID: ' + id + '\nLade LIVE neuâ€¦');
        await loadAllFromGViz(true);
        renderDone();
      } catch (e) {
        showMsg('error', e.message);
      } finally {
        btn.disabled = false;
        btn.textContent = old;
      }
    });
  });
}

/** =========================
 * Wire up
 * ========================= */
$('tab-create').addEventListener('click', () => setTab('create'));
$('tab-open').addEventListener('click', () => setTab('open'));
$('tab-done').addEventListener('click', () => setTab('done'));

$('btnCreate').addEventListener('click', createOrder);

$('openSearch').addEventListener('input', () => { openState.search = $('openSearch').value.trim(); openState.page=1; renderOpen(); });
$('openPrev').addEventListener('click', () => { openState.page=Math.max(1, openState.page-1); renderOpen(); });
$('openNext').addEventListener('click', () => { openState.page+=1; renderOpen(); });

$('doneSearch').addEventListener('input', () => { doneState.search = $('doneSearch').value.trim(); doneState.page=1; renderDone(); });
$('donePrev').addEventListener('click', () => { doneState.page=Math.max(1, doneState.page-1); renderDone(); });
$('doneNext').addEventListener('click', () => { doneState.page+=1; renderDone(); });

$('btnReload').addEventListener('click', async () => {
  try {
    $('btnReload').disabled = true;
    $('syncPill').textContent = 'Sync: aktualisiertâ€¦';
    await loadAllFromGViz(true);
    if ($('tab-open').classList.contains('active')) renderOpen();
    if ($('tab-done').classList.contains('active')) renderDone();
    showMsg('ok', 'LIVE neu geladen.');
  } catch (e) {
    showMsg('error', 'Neu laden fehlgeschlagen:\n' + e.message);
  } finally {
    $('btnReload').disabled = false;
  }
});

hookKostenAuto();

// Boot
(async function init(){
  try{
    await loadAllFromGViz(true);
    setTab('create');
  } catch(e){
    showMsg('error', 'GViz konnte nicht geladen werden.\n' + e.message + '\n\nTipp: Sheet muss "jeder mit Link" lesbar sein.');
  }
})();
</script>
</body>
</html>
