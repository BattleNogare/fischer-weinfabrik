<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fischer Weinfabrik Â· AuftrÃ¤ge</title>
  <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/BattleNogare/h-h_weinfabrik/main/fischer_weinfabrik_logo.png">

  <style>
    :root{
      --bg:#0b0d10; --bg2:#0f1217; --card:#11151c; --card2:#0f131a;
      --text:#e7eaf0; --muted:#a8b0bf; --border: rgba(255,255,255,.08);
      --shadow: 0 12px 34px rgba(0,0,0,.42);
      --accent:#e11d48; --focus: 0 0 0 3px rgba(225,29,72,.25);
      --radius: 14px;
    }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(225,29,72,.20), transparent 55%),
        radial-gradient(900px 500px at 80% 20%, rgba(225,29,72,.10), transparent 50%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      color: var(--text);
    }
    .app{ width:85%; max-width:1300px; margin:22px auto 40px; }
    .topbar{
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      padding:14px 16px;
      background: color-mix(in srgb, var(--card) 92%, transparent);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      position: sticky; top: 14px; backdrop-filter: blur(10px);
      z-index: 10;
    }
    .brand{ display:flex; gap:12px; align-items:center; min-width: 260px; }
    .brand img{
      width:34px; height:34px; border-radius:10px; border:1px solid var(--border);
      background: var(--card2); padding:5px;
    }
    .brand h2{ margin:0; font-size:18px; line-height:1.1; }
    .brand .sub{ margin:2px 0 0; font-size:12px; color:var(--muted); }

    nav{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center; }
    .tab{
      border:1px solid var(--border);
      background: linear-gradient(180deg, color-mix(in srgb, var(--card) 92%, transparent), var(--card2));
      color:var(--text);
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:700;
      transition: transform .08s ease, border-color .2s ease, background .2s ease;
      display:flex; align-items:center; gap:8px;
    }
    .tab:hover{ transform: translateY(-1px); border-color: color-mix(in srgb, var(--accent) 40%, var(--border)); }
    .tab.active{
      border-color: color-mix(in srgb, var(--accent) 70%, var(--border));
      box-shadow: 0 0 0 4px rgba(225,29,72,.14);
      background: linear-gradient(180deg, rgba(225,29,72,.18), rgba(225,29,72,.10));
    }
    .tab .dot{ width:8px; height:8px; border-radius:999px; background: var(--accent); box-shadow: 0 0 0 3px rgba(225,29,72,.15); }
    .actions{ min-width:260px; display:flex; justify-content:flex-end; gap:10px; align-items:center; }
    .pill{
      border:1px solid var(--border);
      background: color-mix(in srgb, var(--card) 85%, transparent);
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
    }

    .grid{ display:grid; grid-template-columns: 1fr; gap:14px; margin-top:14px; }
    .card{
      border:1px solid var(--border);
      background: linear-gradient(180deg, color-mix(in srgb, var(--card) 94%, transparent), var(--card2));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
      overflow:hidden;
    }
    .card h3{ margin:0 0 12px; font-size:16px; }
    .msg{
      padding: 12px 14px; border-radius: 12px;
      border: 1px solid var(--border);
      background: color-mix(in srgb, var(--card) 90%, transparent);
      display:none;
      margin-top: 14px;
      white-space: pre-line;
    }
    .msg.show{ display:block; }
    .msg.ok{ border-color: rgba(34,197,94,.35); }
    .msg.error{ border-color: rgba(239,68,68,.40); }
    .muted{ color:var(--muted); font-size:.92em; }
    .hidden{ display:none !important; }

    .form{ display:grid; grid-template-columns: 1fr; gap:12px; }
    label{ display:block; font-weight: 800; font-size: 13px; }
    input, textarea, select{
      width:100%;
      margin-top:6px;
      padding:10px 11px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: color-mix(in srgb, var(--bg) 35%, var(--card));
      color: var(--text);
      outline:none;
      transition: box-shadow .2s ease, border-color .2s ease;
      box-sizing:border-box;
    }
    textarea{ resize: vertical; min-height: 90px; }
    input:focus, textarea:focus, select:focus{
      box-shadow: var(--focus);
      border-color: color-mix(in srgb, var(--accent) 55%, var(--border));
    }
    input[readonly]{ opacity:.92; cursor:not-allowed; }

    .toolbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:12px; }
    .toolbar input{ max-width:340px; }
    .pager{ display:flex; gap:8px; align-items:center; margin-left:auto; }

    .btn{
      border:1px solid var(--border);
      background: linear-gradient(180deg, color-mix(in srgb, var(--card) 92%, transparent), var(--card2));
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:750;
      transition: transform .08s ease, border-color .2s ease;
      display:inline-flex; align-items:center; gap:8px;
    }
    .btn:hover{ transform: translateY(-1px); border-color: color-mix(in srgb, var(--accent) 40%, var(--border)); }
    .btn:disabled{ opacity:.6; cursor:not-allowed; transform:none; }
    .btn-primary{
      border-color: color-mix(in srgb, var(--accent) 60%, var(--border));
      background: linear-gradient(180deg, rgba(225,29,72,.35), rgba(225,29,72,.15));
    }
    .btn-danger{
      border-color: rgba(239,68,68,.55);
      background: linear-gradient(180deg, rgba(239,68,68,.22), rgba(239,68,68,.12));
    }
    .tiny{ padding: 8px 10px; border-radius: 10px; font-weight: 750; }

    .table-wrap{
      border:1px solid var(--border);
      border-radius: 12px;
      overflow:auto;
      max-height: 70vh;
      background: color-mix(in srgb, var(--card) 85%, transparent);
    }
    table{ width:100%; border-collapse: separate; border-spacing: 0; min-width: 980px; }
    thead th{
      position: sticky; top: 0; z-index: 3;
      font-size:12px; text-transform: uppercase; letter-spacing:.2px;
      color: var(--muted);
      background: color-mix(in srgb, var(--card) 92%, black);
      border-bottom: 1px solid var(--border);
      padding: 10px 10px;
      white-space: nowrap;
    }
    tbody td{ border-bottom: 1px solid var(--border); padding: 10px 10px; vertical-align: top; }
    tbody tr:hover td{ background: rgba(225,29,72,.06); }
    .date-cell input[type="date"]{ padding:8px 10px; border-radius:10px; }

    @media (max-width: 920px){
      .app{ width:94%; }
      .pager{ margin-left: 0; }
      .actions{ min-width:auto; }
      .brand{ min-width:auto; }
      table{ min-width: 920px; }
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <img alt="Logo" src="https://raw.githubusercontent.com/BattleNogare/h-h_weinfabrik/main/fischer_weinfabrik_logo.png">
        <div>
          <h2>AuftrÃ¤ge</h2>
          <p class="sub">Backend: Supabase Edge Function Â· OPEN (ohne Key)</p>
        </div>
      </div>

      <nav>
        <button id="tab-create" class="tab active"><span class="dot"></span>Auftrag erstellen</button>
        <button id="tab-open" class="tab"><span class="dot"></span>Offene AuftrÃ¤ge</button>
        <button id="tab-done" class="tab"><span class="dot"></span>Fertige AuftrÃ¤ge</button>
      </nav>

      <div class="actions">
        <span id="syncPill" class="pill">Sync: â€“</span>
        <button id="btnReload" class="btn tiny">â†» Neu laden</button>
        <span class="pill">Sortierung: ID â†‘</span>
      </div>
    </div>

    <div id="msg" class="msg"></div>

    <div class="grid">
      <section id="view-create" class="card">
        <h3>Auftrag erstellen</h3>

        <div class="form">
          <div><label>Kunde*<input id="fKunde" type="text" required /></label></div>
          <div><label>Mitarbeiter*<input id="fMitarbeiter" type="text" required /></label></div>
          <div><label>Anzahl FÃ¤sser*<input id="fAnzahl" type="number" min="0" step="1" required /></label></div>
          <div><label>Prozent* (1â€“100)<input id="fProzent" type="number" min="1" max="100" step="1" required /></label></div>
          <div><label>Kosten (automatisch)<input id="fKosten" type="text" readonly /></label></div>
          <div><label>Info<textarea id="fInfo" rows="3"></textarea></label></div>
        </div>

        <div style="margin-top: 14px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <button id="btnCreate" class="btn btn-primary">ðŸ’¾ Speichern</button>
          <span class="muted">* Pflichtfelder</span>
        </div>

        <div class="muted" style="margin-top:10px;">
          Hinweis: AuftragsDatum wird automatisch gesetzt. Neue AuftrÃ¤ge starten immer mit â€žErhalten = Neinâ€œ.
        </div>
      </section>

      <section id="view-open" class="card hidden">
        <h3>Offene AuftrÃ¤ge</h3>

        <div class="toolbar">
          <input id="openSearch" type="text" placeholder="Suche Kunde/Mitarbeiterâ€¦" />
          <div class="pager">
            <button id="openPrev" class="btn tiny">â—€</button>
            <span id="openPageInfo" class="pill"></span>
            <button id="openNext" class="btn tiny">â–¶</button>
          </div>
        </div>

        <div id="openTableWrap"></div>
      </section>

      <section id="view-done" class="card hidden">
        <h3>Fertige AuftrÃ¤ge</h3>

        <div class="toolbar">
          <input id="doneSearch" type="text" placeholder="Suche Kunde/Mitarbeiterâ€¦" />
          <div class="pager">
            <button id="donePrev" class="btn tiny">â—€</button>
            <span id="donePageInfo" class="pill"></span>
            <button id="doneNext" class="btn tiny">â–¶</button>
          </div>
        </div>

        <div id="doneTableWrap"></div>
      </section>
    </div>
  </div>

<script>
/** =========================
 * CONFIG
 * ========================= */
const API_URL = 'https://mtyaczfezilcnllnwgqq.supabase.co/functions/v1/auftraege-api';
const PAGE_SIZE = 50;
const DEBUG = true;

/** =========================
 * Helpers
 * ========================= */
const $ = (id) => document.getElementById(id);
function log(...args){ if (DEBUG) console.log('[SB-OPEN]', ...args); }

function showMsg(type, text) {
  const el = $('msg');
  el.className = 'msg show ' + (type === 'error' ? 'error' : 'ok');
  el.textContent = text;
  clearTimeout(showMsg._t);
  showMsg._t = setTimeout(() => { el.className = 'msg'; el.textContent=''; }, 5200);
}

function setTab(tab) {
  const tabs = ['create','open','done'];
  for (const t of tabs) {
    $('tab-' + t).classList.toggle('active', t === tab);
    $('view-' + t).classList.toggle('hidden', t !== tab);
  }
  if (tab === 'open') { loadAndRenderOpen().catch(e => showMsg('error', e.message)); }
  if (tab === 'done') { loadAndRenderDone().catch(e => showMsg('error', e.message)); }
}

function todayISO() {
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd}`;
}
const TODAY_MIN = todayISO();
function isDateBeforeToday(dateStr) { return !!dateStr && dateStr < TODAY_MIN; }

function toInt(v){
  const n = Math.trunc(Number(String(v ?? '').replace(',', '.')));
  return Number.isFinite(n) ? n : 0;
}
function escapeHtml(s) {
  return String(s ?? '')
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#039;');
}
function computeKosten(anzahl, prozent) {
  const a = Number(anzahl);
  const p = Number(prozent);
  if (!Number.isFinite(a) || !Number.isFinite(p)) return '';
  const val = (a * 8 * 1299) * (p / 100);
  return Math.round(val).toLocaleString('de-DE') + ' â‚¬';
}
function moneyEUR(n) {
  const v = Number(n);
  if (!Number.isFinite(v)) return '';
  return Math.round(v).toLocaleString('de-DE') + ' â‚¬';
}

/** =========================
 * API client (OPEN mode â€“ no key)
 * ========================= */
async function apiFetch(path, { method="GET", body=null } = {}) {
  const url = API_URL + path;
  const headers = {};
  const init = { method, headers };

  if (body !== null) {
    headers["content-type"] = "application/json";
    init.body = JSON.stringify(body);
  }

  log('FETCH', method, url, body || '');
  const res = await fetch(url, init);

  let json;
  try { json = await res.json(); }
  catch { throw new Error("Antwort ist kein JSON (Server/CORS)."); }

  if (!res.ok || !json.ok) {
    throw new Error((json && json.error ? json.error : 'Request failed') + (json && json.detail ? `\n${json.detail}` : ''));
  }
  return json;
}

async function apiList(status, limit=1000, offset=0){
  return apiFetch(`?action=list&status=${encodeURIComponent(status)}&limit=${limit}&offset=${offset}`);
}
async function apiCreate(payload){
  return apiFetch(`?action=create`, { method:"POST", body: payload });
}
async function apiPatch(payload){
  return apiFetch(`?action=patch`, { method:"POST", body: payload });
}
async function apiDelete(id){
  return apiFetch(`?action=delete`, { method:"POST", body: { id } });
}

/** =========================
 * Data + pagination/search
 * ========================= */
let allOpen = [];
let allDone = [];
let lastSync = null;

let openState = { page: 1, search: '' };
let doneState = { page: 1, search: '' };

function applySearchAndPage(rows, state) {
  const q = String(state.search || '').trim().toLowerCase();
  let filtered = rows;

  if (q) {
    filtered = rows.filter(r =>
      String(r.kunde || '').toLowerCase().includes(q) ||
      String(r.mitarbeiter || '').toLowerCase().includes(q)
    );
  }

  filtered.sort((a,b) => (a.id||0) - (b.id||0));

  const total = filtered.length;
  const start = (state.page - 1) * PAGE_SIZE;
  const items = filtered.slice(start, start + PAGE_SIZE);
  return { total, items };
}

function setSyncPill(){
  if (!lastSync) $('syncPill').textContent = 'Sync: â€“';
  else $('syncPill').textContent = 'Sync: ' + lastSync.toLocaleString('de-DE');
}

async function loadAndRenderOpen(){
  const out = await apiList('open', 1000, 0);
  allOpen = out.items || [];
  lastSync = new Date();
  setSyncPill();
  renderOpen();
}
async function loadAndRenderDone(){
  const out = await apiList('done', 1000, 0);
  allDone = out.items || [];
  lastSync = new Date();
  setSyncPill();
  renderDone();
}
async function loadAllForReload(){
  const [o,d] = await Promise.all([apiList('open', 1000, 0), apiList('done', 1000, 0)]);
  allOpen = o.items || [];
  allDone = d.items || [];
  lastSync = new Date();
  setSyncPill();
  if ($('tab-open').classList.contains('active')) renderOpen();
  if ($('tab-done').classList.contains('active')) renderDone();
}

/** =========================
 * UI render
 * ========================= */
function renderOpen() {
  const { total, items } = applySearchAndPage(allOpen, openState);

  $('openPageInfo').textContent = `Seite ${openState.page} Â· ${total} Treffer`;
  $('openPrev').disabled = openState.page <= 1;
  $('openNext').disabled = (openState.page * PAGE_SIZE) >= total;

  const wrap = $('openTableWrap');
  if (!items.length) { wrap.innerHTML = '<div class="muted">Keine offenen AuftrÃ¤ge gefunden.</div>'; return; }

  wrap.innerHTML = `
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Kunde</th>
            <th>Mitarbeiter</th>
            <th>Anzahl</th>
            <th>Prozent</th>
            <th>Kosten</th>
            <th>AbholDatum</th>
            <th>Erhalten?</th>
            <th>Info</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          ${items.map(r => {
            const abhol = (r.abhol_datum || '') ? String(r.abhol_datum).slice(0,10) : '';
            return `
              <tr>
                <td>${r.id}</td>
                <td>${escapeHtml(r.kunde)}</td>
                <td>${escapeHtml(r.mitarbeiter)}</td>
                <td>${toInt(r.anzahl)}</td>
                <td>${toInt(r.prozent)}</td>
                <td>${moneyEUR(r.kosten)}</td>
                <td class="date-cell">
                  <input type="date" min="${TODAY_MIN}" data-id="${r.id}" class="open-abhol" value="${escapeHtml(abhol)}">
                </td>
                <td>
                  <select data-id="${r.id}" class="open-erhalten">
                    <option value="0" selected>Nein</option>
                    <option value="1">Ja</option>
                  </select>
                  <div class="muted">Ja nur mit AbholDatum</div>
                </td>
                <td><textarea data-id="${r.id}" class="open-info" rows="2">${escapeHtml(r.info || '')}</textarea></td>
                <td><button data-id="${r.id}" class="btn tiny btn-primary open-save">Speichern</button></td>
              </tr>
            `;
          }).join('')}
        </tbody>
      </table>
    </div>
  `;

  wrap.querySelectorAll('.open-save').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = Number(btn.getAttribute('data-id'));
      const info = wrap.querySelector('.open-info[data-id="' + id + '"]').value;
      const erhalten = wrap.querySelector('.open-erhalten[data-id="' + id + '"]').value;
      const abhol = wrap.querySelector('.open-abhol[data-id="' + id + '"]').value;

      if (abhol && isDateBeforeToday(abhol)) { showMsg('error', 'AbholDatum darf nicht in der Vergangenheit liegen.'); return; }
      if (erhalten === '1' && !abhol) { showMsg('error', 'Bitte zuerst ein AbholDatum auswÃ¤hlen (Pflicht), bevor "Erhalten = Ja" gesetzt wird.'); return; }

      btn.disabled = true;
      const old = btn.textContent;
      btn.textContent = 'Speichertâ€¦';

      try {
        await apiPatch({
          id,
          info,
          abhol_datum: abhol || null,
          erhalten: (erhalten === '1')
        });
        showMsg('ok', 'Gespeichert. ID: ' + id);
        await loadAndRenderOpen();
      } catch (e) {
        showMsg('error', e.message);
      } finally {
        btn.disabled = false;
        btn.textContent = old;
      }
    });
  });
}

function renderDone() {
  const { total, items } = applySearchAndPage(allDone, doneState);

  $('donePageInfo').textContent = `Seite ${doneState.page} Â· ${total} Treffer`;
  $('donePrev').disabled = doneState.page <= 1;
  $('doneNext').disabled = (doneState.page * PAGE_SIZE) >= total;

  const wrap = $('doneTableWrap');
  if (!items.length) { wrap.innerHTML = '<div class="muted">Keine fertigen AuftrÃ¤ge gefunden.</div>'; return; }

  wrap.innerHTML = `
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>AuftragsDatum</th>
            <th>Kunde</th>
            <th>Mitarbeiter</th>
            <th>Anzahl</th>
            <th>Prozent</th>
            <th>Kosten</th>
            <th>AbholDatum</th>
            <th>Info</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          ${items.map(r => {
            const auftrags = r.auftrags_datum ? new Date(r.auftrags_datum).toLocaleString('de-DE') : '';
            const abhol = (r.abhol_datum || '') ? String(r.abhol_datum).slice(0,10) : '';
            return `
              <tr>
                <td>${r.id}</td>
                <td>${escapeHtml(auftrags)}</td>
                <td>${escapeHtml(r.kunde)}</td>
                <td>${escapeHtml(r.mitarbeiter)}</td>
                <td>${toInt(r.anzahl)}</td>
                <td>${toInt(r.prozent)}</td>
                <td>${moneyEUR(r.kosten)}</td>
                <td>${escapeHtml(abhol)}</td>
                <td>${escapeHtml(r.info || '')}</td>
                <td><button data-id="${r.id}" class="btn tiny btn-danger done-del">LÃ¶schen</button></td>
              </tr>
            `;
          }).join('')}
        </tbody>
      </table>
    </div>
  `;

  wrap.querySelectorAll('.done-del').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = Number(btn.getAttribute('data-id'));
      if (!confirm('Auftrag ID ' + id + ' wirklich lÃ¶schen?')) return;

      btn.disabled = true;
      const old = btn.textContent;
      btn.textContent = 'LÃ¶schtâ€¦';

      try {
        await apiDelete(id);
        showMsg('ok', 'GelÃ¶scht. ID: ' + id);
        await loadAndRenderDone();
      } catch (e) {
        showMsg('error', e.message);
      } finally {
        btn.disabled = false;
        btn.textContent = old;
      }
    });
  });
}

/** =========================
 * Create
 * ========================= */
function validateCreateForm() {
  const kunde = $('fKunde').value.trim();
  const mitarbeiter = $('fMitarbeiter').value.trim();
  const anzahl = toInt($('fAnzahl').value);
  const prozent = toInt($('fProzent').value);

  if (!kunde) throw new Error('Kunde ist Pflichtfeld.');
  if (!mitarbeiter) throw new Error('Mitarbeiter ist Pflichtfeld.');
  if (!Number.isInteger(anzahl) || anzahl < 0) throw new Error('Anzahl muss eine nicht-negative Ganzzahl sein.');
  if (!Number.isInteger(prozent) || prozent < 1 || prozent > 100) throw new Error('Prozent muss 1â€“100 (Ganzzahl) sein.');
}

function hookKostenAuto() {
  const recalc = () => { $('fKosten').value = computeKosten($('fAnzahl').value, $('fProzent').value); };
  $('fAnzahl').addEventListener('input', recalc);
  $('fProzent').addEventListener('input', recalc);
  recalc();
}

async function createOrder() {
  const btn = $('btnCreate');
  btn.disabled = true;
  const old = btn.textContent;
  btn.textContent = 'Speichertâ€¦';

  try {
    validateCreateForm();

    const kunde = $('fKunde').value.trim();
    const mitarbeiter = $('fMitarbeiter').value.trim();
    const anzahl = toInt($('fAnzahl').value);
    const prozent = toInt($('fProzent').value);
    const info = $('fInfo').value.trim();

    await apiCreate({ kunde, mitarbeiter, anzahl, prozent, info });

    showMsg('ok', 'Gespeichert.');

    $('fKunde').value = '';
    $('fMitarbeiter').value = '';
    $('fAnzahl').value = '';
    $('fProzent').value = '';
    $('fInfo').value = '';
    $('fKosten').value = '';

    // refresh open list so the new item shows up
    await loadAndRenderOpen();

  } catch (e) {
    showMsg('error', e.message);
  } finally {
    btn.disabled = false;
    btn.textContent = old;
  }
}

/** =========================
 * Wire up
 * ========================= */
$('tab-create').addEventListener('click', () => setTab('create'));
$('tab-open').addEventListener('click', () => setTab('open'));
$('tab-done').addEventListener('click', () => setTab('done'));

$('btnCreate').addEventListener('click', createOrder);

$('openSearch').addEventListener('input', () => { openState.search = $('openSearch').value.trim(); openState.page=1; renderOpen(); });
$('openPrev').addEventListener('click', () => { openState.page=Math.max(1, openState.page-1); renderOpen(); });
$('openNext').addEventListener('click', () => { openState.page+=1; renderOpen(); });

$('doneSearch').addEventListener('input', () => { doneState.search = $('doneSearch').value.trim(); doneState.page=1; renderDone(); });
$('donePrev').addEventListener('click', () => { doneState.page=Math.max(1, doneState.page-1); renderDone(); });
$('doneNext').addEventListener('click', () => { doneState.page+=1; renderDone(); });

$('btnReload').addEventListener('click', async () => {
  try {
    $('btnReload').disabled = true;
    $('syncPill').textContent = 'Sync: aktualisiertâ€¦';
    await loadAllForReload();
    showMsg('ok', 'Neu geladen.');
  } catch (e) {
    showMsg('error', e.message);
  } finally {
    $('btnReload').disabled = false;
  }
});

hookKostenAuto();

// Boot
(async function init(){
  try{
    await loadAllForReload();
    setTab('create');
  } catch(e){
    showMsg('error', e.message);
  }
})();
</script>
</body>
</html>
