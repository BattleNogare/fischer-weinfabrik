<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AuftrÃ¤ge</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/BattleNogare/h-h_weinfabrik/main/fischer_weinfabrik_logo.png">

  <style>
    :root{
      --bg: #0b0d10;
      --bg2:#0f1217;
      --card:#11151c;
      --card2:#0f131a;
      --text:#e7eaf0;
      --muted:#a8b0bf;
      --border: rgba(255,255,255,.08);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --accent:#e11d48;      /* rot */
      --accent2:#fb7185;     /* helleres rot */
      --good:#22c55e;
      --warn:#f59e0b;
      --error:#ef4444;
      --focus: 0 0 0 3px rgba(225,29,72,.25);
      --radius: 14px;
    }

    /* Optional: Light mode fallback via system preference */
    @media (prefers-color-scheme: light) {
      :root{
        --bg:#f6f7fb;
        --bg2:#eef1f7;
        --card:#ffffff;
        --card2:#ffffff;
        --text:#0f172a;
        --muted:#475569;
        --border: rgba(2,6,23,.10);
        --shadow: 0 10px 30px rgba(2,6,23,.08);
        --focus: 0 0 0 3px rgba(225,29,72,.18);
      }
    }

    /* Manual dark-mode toggle class */
    body.force-dark{
      --bg: #0b0d10;
      --bg2:#0f1217;
      --card:#11151c;
      --card2:#0f131a;
      --text:#e7eaf0;
      --muted:#a8b0bf;
      --border: rgba(255,255,255,.08);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --focus: 0 0 0 3px rgba(225,29,72,.25);
    }
    body.force-light{
      --bg:#f6f7fb;
      --bg2:#eef1f7;
      --card:#ffffff;
      --card2:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --border: rgba(2,6,23,.10);
      --shadow: 0 10px 30px rgba(2,6,23,.08);
      --focus: 0 0 0 3px rgba(225,29,72,.18);
    }

    * { box-sizing: border-box; }
    html, body { height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(225,29,72,.18), transparent 55%),
        radial-gradient(900px 500px at 80% 20%, rgba(225,29,72,.10), transparent 50%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      color: var(--text);
    }

    .app{
      width: 85%;
      max-width: 1300px;
      margin: 22px auto 40px;
    }

    .topbar{
      display:flex;
      gap:14px;
      align-items:center;
      justify-content: space-between;
      padding: 14px 16px;
      background: color-mix(in srgb, var(--card) 90%, transparent);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      position: sticky;
      top: 14px;
      backdrop-filter: blur(10px);
      z-index: 10;
    }

    .brand{
      display:flex;
      gap:12px;
      align-items:center;
      min-width: 220px;
    }
    .brand img{
      width: 34px;
      height: 34px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--card2);
      padding: 5px;
    }
    .brand h2{
      margin:0;
      font-size: 18px;
      letter-spacing: .2px;
      line-height: 1.1;
    }
    .brand .sub{
      margin:0;
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
    }

    nav{
      display:flex;
      gap:8px;
      flex-wrap: wrap;
      justify-content:center;
    }

    .tab{
      border: 1px solid var(--border);
      background: linear-gradient(180deg, color-mix(in srgb, var(--card) 92%, transparent), var(--card2));
      color: var(--text);
      padding: 10px 12px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 600;
      transition: transform .08s ease, border-color .2s ease, background .2s ease;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .tab:hover{ transform: translateY(-1px); border-color: color-mix(in srgb, var(--accent) 40%, var(--border)); }
    .tab.active{
      border-color: color-mix(in srgb, var(--accent) 70%, var(--border));
      box-shadow: 0 0 0 4px rgba(225,29,72,.14);
      background: linear-gradient(180deg, rgba(225,29,72,.18), rgba(225,29,72,.10));
    }
    .tab .dot{
      width: 8px; height: 8px; border-radius: 999px;
      background: color-mix(in srgb, var(--accent) 60%, #fff 0%);
      box-shadow: 0 0 0 3px rgba(225,29,72,.15);
    }

    .actions{
      display:flex;
      gap:10px;
      align-items:center;
      min-width: 220px;
      justify-content:flex-end;
    }

    .btn{
      border: 1px solid var(--border);
      background: linear-gradient(180deg, color-mix(in srgb, var(--card) 92%, transparent), var(--card2));
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight: 650;
      transition: transform .08s ease, border-color .2s ease;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .btn:hover{ transform: translateY(-1px); border-color: color-mix(in srgb, var(--accent) 40%, var(--border)); }
    .btn:active{ transform: translateY(0px); }
    .btn-primary{
      border-color: color-mix(in srgb, var(--accent) 60%, var(--border));
      background: linear-gradient(180deg, rgba(225,29,72,.35), rgba(225,29,72,.15));
    }
    .btn-danger{
      border-color: rgba(239,68,68,.55);
      background: linear-gradient(180deg, rgba(239,68,68,.22), rgba(239,68,68,.12));
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
      margin-top: 14px;
    }

    .card{
      border: 1px solid var(--border);
      background: linear-gradient(180deg, color-mix(in srgb, var(--card) 94%, transparent), var(--card2));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
      overflow: hidden;
    }
    .card h3{
      margin:0 0 12px;
      font-size: 16px;
      letter-spacing: .2px;
    }

    .msg{
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: color-mix(in srgb, var(--card) 90%, transparent);
      display:none;
    }
    .msg.show{ display:block; }
    .msg.ok{ border-color: rgba(34,197,94,.35); }
    .msg.error{ border-color: rgba(239,68,68,.40); }

    .muted{ color: var(--muted); font-size: 0.92em; }
    .hidden{ display:none !important; }

    .form{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .form .full{ grid-column: 1 / -1; }

    label{ display:block; font-weight: 650; font-size: 13px; letter-spacing: .2px; }
    input, textarea, select{
      width:100%;
      margin-top:6px;
      padding: 10px 11px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: color-mix(in srgb, var(--bg) 35%, var(--card));
      color: var(--text);
      outline: none;
      transition: box-shadow .2s ease, border-color .2s ease;
    }
    textarea{ resize: vertical; min-height: 90px; }
    input:focus, textarea:focus, select:focus{
      box-shadow: var(--focus);
      border-color: color-mix(in srgb, var(--accent) 55%, var(--border));
    }
    input[readonly]{
      opacity: .92;
      cursor:not-allowed;
      background: color-mix(in srgb, var(--bg) 50%, var(--card));
    }

    .toolbar{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }
    .toolbar input{
      max-width: 340px;
    }
    .pager{
      display:flex;
      gap:8px;
      align-items:center;
      margin-left:auto;
    }
    .pill{
      border: 1px solid var(--border);
      background: color-mix(in srgb, var(--card) 85%, transparent);
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted);
    }

    table{
      width:100%;
      border-collapse: collapse;
      overflow: hidden;
      border-radius: 12px;
    }
    thead th{
      font-size: 12px;
      letter-spacing: .2px;
      text-transform: uppercase;
      color: var(--muted);
      background: color-mix(in srgb, var(--card) 80%, transparent);
      border-bottom: 1px solid var(--border);
      padding: 10px 10px;
      white-space: nowrap;
    }
    tbody td{
      border-bottom: 1px solid var(--border);
      padding: 10px 10px;
      vertical-align: top;
    }
    tbody tr:hover td{
      background: rgba(225,29,72,.06);
    }
    .row-actions{ display:flex; gap:8px; align-items:center; }
    .tiny{ padding: 8px 10px; border-radius: 10px; font-weight: 650; }

    @media (max-width: 920px){
      .app{ width: 94%; }
      .brand{ min-width: unset; }
      .actions{ min-width: unset; }
      .form{ grid-template-columns: 1fr; }
      .pager{ margin-left: 0; }
    }
  </style>
</head>

<body class="force-dark">
  <div class="app">

    <div class="topbar">
      <div class="brand">
        <img alt="Logo" src="https://raw.githubusercontent.com/BattleNogare/h-h_weinfabrik/main/fischer_weinfabrik_logo.png">
        <div>
          <h2>AuftrÃ¤ge</h2>
          <p class="sub">Fischer Weinfabrik Â· interne Desktop-App</p>
        </div>
      </div>

      <nav>
        <button id="tab-create" class="tab active"><span class="dot"></span>Auftrag erstellen</button>
        <button id="tab-open" class="tab"><span class="dot"></span>Offene AuftrÃ¤ge</button>
        <button id="tab-done" class="tab"><span class="dot"></span>Fertige AuftrÃ¤ge</button>
      </nav>

      <div class="actions">
        <button id="themeToggle" class="btn" title="Hell/Dunkel umschalten">ðŸŒ“ Theme</button>
      </div>
    </div>

    <div id="msg" class="msg"></div>

    <div class="grid">

      <!-- CREATE -->
      <section id="view-create" class="card">
        <h3>Auftrag erstellen</h3>

        <div class="form">
          <div>
            <label>Kunde*<input id="fKunde" type="text" required /></label>
          </div>

          <div>
            <label>Mitarbeiter*<input id="fMitarbeiter" type="text" required /></label>
          </div>

          <div>
            <label>Anzahl FÃ¤sser*<input id="fAnzahl" type="number" min="0" step="1" required /></label>
          </div>

          <div>
            <label>Prozent* (1â€“100)<input id="fProzent" type="number" min="1" max="100" step="1" required /></label>
          </div>

          <div>
            <label>Kosten (automatisch)
              <input id="fKosten" type="text" readonly />
            </label>
          </div>

          <div>
            <label>Kunde hat alle Weinflaschen erhalten?
              <select id="fErhalten">
                <option value="false" selected>Nein</option>
                <option value="true">Ja</option>
              </select>
            </label>
            <div class="muted">Hinweis: Neue AuftrÃ¤ge werden immer als â€žNeinâ€œ gespeichert.</div>
          </div>

          <div class="full">
            <label>Info<textarea id="fInfo" rows="3"></textarea></label>
          </div>
        </div>

        <div style="margin-top: 14px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <button id="btnCreate" class="btn btn-primary">ðŸ’¾ Speichern</button>
          <span class="muted">* Pflichtfelder</span>
        </div>
      </section>

      <!-- OPEN -->
      <section id="view-open" class="card hidden">
        <h3>Offene AuftrÃ¤ge</h3>

        <div class="toolbar">
          <input id="openSearch" type="text" placeholder="Suche Kunde/Mitarbeiterâ€¦" />
          <span class="pill">Sortierung: ID â†‘</span>

          <div class="pager">
            <button id="openPrev" class="btn tiny">â—€</button>
            <span id="openPageInfo" class="pill"></span>
            <button id="openNext" class="btn tiny">â–¶</button>
          </div>
        </div>

        <div id="openTableWrap"></div>
      </section>

      <!-- DONE -->
      <section id="view-done" class="card hidden">
        <h3>Fertige AuftrÃ¤ge</h3>

        <div class="toolbar">
          <input id="doneSearch" type="text" placeholder="Suche Kunde/Mitarbeiterâ€¦" />
          <span class="pill">Sortierung: ID â†‘</span>

          <div class="pager">
            <button id="donePrev" class="btn tiny">â—€</button>
            <span id="donePageInfo" class="pill"></span>
            <button id="doneNext" class="btn tiny">â–¶</button>
          </div>
        </div>

        <div id="doneTableWrap"></div>
      </section>

    </div>
  </div>

<script>
  // ====== CONFIG ======
  const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbyrbnoenHlCFKW1Lk1bI_GOf9WFlw7IR9Y_fxZAsaOfG57Ddy4Ei2ENTTNCSN1IyypmzQ/exec'; // z.B. https://script.google.com/macros/s/.../exec
  const API_TOKEN = ''; // muss zu Code.gs passen (oder leer lassen)
  const PAGE_SIZE = 50;

  // ====== Helpers ======
  const $ = (id) => document.getElementById(id);

  function showMsg(type, text) {
    const el = $('msg');
    el.className = 'msg show ' + (type === 'error' ? 'error' : 'ok');
    el.textContent = text;
    clearTimeout(showMsg._t);
    showMsg._t = setTimeout(() => { el.className = 'msg'; el.textContent=''; }, 4200);
  }

  function setTab(tab) {
    const tabs = ['create','open','done'];
    for (const t of tabs) {
      $('tab-' + t).classList.toggle('active', t === tab);
      $('view-' + t).classList.toggle('hidden', t !== tab);
    }
    if (tab === 'open') loadOpen();
    if (tab === 'done') loadDone();
  }

  // ====== Theme Toggle ======
  function setTheme(mode) {
    // mode: 'dark'|'light'
    document.body.classList.remove('force-dark','force-light');
    document.body.classList.add(mode === 'dark' ? 'force-dark' : 'force-light');
    localStorage.setItem('theme', mode);
  }
  function initTheme() {
    const saved = localStorage.getItem('theme');
    if (saved === 'light' || saved === 'dark') return setTheme(saved);
    // default: dark (du wolltest Darkmode)
    setTheme('dark');
  }

  // ====== API ======
  async function apiGet(params = {}) {
    const url = new URL(API_BASE_URL);
    if (API_TOKEN) params.token = API_TOKEN;
    Object.entries(params).forEach(([k,v]) => url.searchParams.set(k, v));
    const res = await fetch(url.toString(), { method: 'GET' });
    const data = await res.json();
    if (!data.ok) throw new Error(data.error || 'API Fehler');
    return data;
  }

  async function apiPost(body, params = {}) {
    const url = new URL(API_BASE_URL);
    if (API_TOKEN) params.token = API_TOKEN;
    Object.entries(params).forEach(([k,v]) => url.searchParams.set(k, v));
    const res = await fetch(url.toString(), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body || {})
    });
    const data = await res.json();
    if (!data.ok) throw new Error(data.error || 'API Fehler');
    return data;
  }

  // ====== business rules / validation ======
  function computeKosten(anzahl, prozent) {
    const a = Number(anzahl);
    const p = Number(prozent);
    if (!Number.isFinite(a) || !Number.isFinite(p)) return '';
    return ((a * 8 * 1299) * (p / 100)).toFixed(2);
  }

  function validateCreateForm() {
    const kunde = $('fKunde').value.trim();
    const mitarbeiter = $('fMitarbeiter').value.trim();
    const anzahl = Number($('fAnzahl').value);
    const prozent = Number($('fProzent').value);

    if (!kunde) throw new Error('Kunde ist Pflichtfeld.');
    if (!mitarbeiter) throw new Error('Mitarbeiter ist Pflichtfeld.');
    if (!Number.isInteger(anzahl) || anzahl < 0) throw new Error('Anzahl muss eine nicht-negative Ganzzahl sein.');
    if (!Number.isInteger(prozent) || prozent < 1 || prozent > 100) throw new Error('Prozent muss 1â€“100 (Ganzzahl) sein.');
  }

  function hookKostenAuto() {
    const recalc = () => $('fKosten').value = computeKosten($('fAnzahl').value, $('fProzent').value);
    $('fAnzahl').addEventListener('input', recalc);
    $('fProzent').addEventListener('input', recalc);
    recalc();
  }

  // ====== create ======
  async function createOrder() {
    try {
      validateCreateForm();

      const body = {
        Kunde: $('fKunde').value.trim(),
        Mitarbeiter: $('fMitarbeiter').value.trim(),
        Anzahl: Number($('fAnzahl').value),
        Prozent: Number($('fProzent').value),
        Info: $('fInfo').value.trim()
      };

      const data = await apiPost(body);
      showMsg('ok', 'Auftrag gespeichert. ID: ' + data.item.ID);

      $('fKunde').value = '';
      $('fMitarbeiter').value = '';
      $('fAnzahl').value = '';
      $('fProzent').value = '';
      $('fInfo').value = '';
      $('fErhalten').value = 'false';
      $('fKosten').value = '';
    } catch (e) {
      showMsg('error', e.message);
    }
  }

  // ====== open/done lists ======
  let openState = { page: 1, search: '' };
  let doneState = { page: 1, search: '' };

  async function loadOpen() {
    try {
      const data = await apiGet({
        status: 'open',
        search: openState.search,
        page: openState.page,
        limit: PAGE_SIZE,
        sort: 'id_asc'
      });
      $('openPageInfo').textContent = `Seite ${openState.page} Â· ${data.total} Treffer`;
      renderOpenTable(data.items);
      $('openPrev').disabled = openState.page <= 1;
      $('openNext').disabled = (openState.page * PAGE_SIZE) >= data.total;
    } catch (e) {
      showMsg('error', e.message);
    }
  }

  async function loadDone() {
    try {
      const data = await apiGet({
        status: 'done',
        search: doneState.search,
        page: doneState.page,
        limit: PAGE_SIZE,
        sort: 'id_asc'
      });
      $('donePageInfo').textContent = `Seite ${doneState.page} Â· ${data.total} Treffer`;
      renderDoneTable(data.items);
      $('donePrev').disabled = doneState.page <= 1;
      $('doneNext').disabled = (doneState.page * PAGE_SIZE) >= data.total;
    } catch (e) {
      showMsg('error', e.message);
    }
  }

  function renderOpenTable(items) {
    const wrap = $('openTableWrap');
    if (!items.length) { wrap.innerHTML = '<div class="muted">Keine offenen AuftrÃ¤ge gefunden.</div>'; return; }

    const rows = items.map(r => `
      <tr>
        <td>${r.ID}</td>
        <td>${escapeHtml(r.Kunde)}</td>
        <td>${escapeHtml(r.Mitarbeiter)}</td>
        <td>${r.Anzahl}</td>
        <td>${r.Prozent}</td>
        <td>${Number(r.Kosten).toFixed(2)}</td>
        <td>
          <select data-id="${r.ID}" class="open-erhalten">
            <option value="false" selected>Nein</option>
            <option value="true">Ja</option>
          </select>
          <div class="muted">Nur auf â€žJaâ€œ setzbar</div>
        </td>
        <td>
          <textarea data-id="${r.ID}" class="open-info" rows="2">${escapeHtml(r.Info || '')}</textarea>
        </td>
        <td class="row-actions">
          <button data-id="${r.ID}" class="btn tiny btn-primary open-save">Speichern</button>
        </td>
      </tr>
    `).join('');

    wrap.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>ID</th><th>Kunde</th><th>Mitarbeiter</th><th>Anzahl</th><th>%</th><th>Kosten</th>
            <th>Erhalten?</th><th>Info</th><th></th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;

    wrap.querySelectorAll('.open-save').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.getAttribute('data-id');
        const info = wrap.querySelector(`.open-info[data-id="${id}"]`).value;
        const erhaltenVal = wrap.querySelector(`.open-erhalten[data-id="${id}"]`).value;

        try {
          await apiPost({
            Info: info,
            'Kunde hat alle Weinflaschen erhalten?': (erhaltenVal === 'true')
          }, { method: 'PATCH', id });

          showMsg('ok', 'Gespeichert. ID: ' + id);
          await loadOpen();
        } catch (e) {
          showMsg('error', e.message);
          wrap.querySelector(`.open-erhalten[data-id="${id}"]`).value = 'false';
        }
      });
    });
  }

  function renderDoneTable(items) {
    const wrap = $('doneTableWrap');
    if (!items.length) { wrap.innerHTML = '<div class="muted">Keine fertigen AuftrÃ¤ge gefunden.</div>'; return; }

    const rows = items.map(r => `
      <tr>
        <td>${r.ID}</td>
        <td>${escapeHtml(r.Kunde)}</td>
        <td>${escapeHtml(r.Mitarbeiter)}</td>
        <td>${r.Anzahl}</td>
        <td>${r.Prozent}</td>
        <td>${Number(r.Kosten).toFixed(2)}</td>
        <td>Ja</td>
        <td>${escapeHtml(r.Info || '')}</td>
        <td class="row-actions">
          <button data-id="${r.ID}" class="btn tiny btn-danger done-del">LÃ¶schen</button>
        </td>
      </tr>
    `).join('');

    wrap.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>ID</th><th>Kunde</th><th>Mitarbeiter</th><th>Anzahl</th><th>%</th><th>Kosten</th>
            <th>Erhalten?</th><th>Info</th><th></th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;

    wrap.querySelectorAll('.done-del').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.getAttribute('data-id');
        if (!confirm('Auftrag ID ' + id + ' wirklich lÃ¶schen?')) return;

        try {
          await apiPost({}, { method: 'DELETE', id });
          showMsg('ok', 'GelÃ¶scht. ID: ' + id);
          await loadDone();
        } catch (e) {
          showMsg('error', e.message);
        }
      });
    });
  }

  function escapeHtml(s) {
    return String(s)
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#039;');
  }

  // ====== wiring ======
  $('tab-create').addEventListener('click', () => setTab('create'));
  $('tab-open').addEventListener('click', () => setTab('open'));
  $('tab-done').addEventListener('click', () => setTab('done'));

  $('btnCreate').addEventListener('click', createOrder);
  hookKostenAuto();

  $('openSearch').addEventListener('input', () => {
    openState.search = $('openSearch').value.trim();
    openState.page = 1;
    loadOpen();
  });
  $('openPrev').addEventListener('click', () => { openState.page = Math.max(1, openState.page - 1); loadOpen(); });
  $('openNext').addEventListener('click', () => { openState.page += 1; loadOpen(); });

  $('doneSearch').addEventListener('input', () => {
    doneState.search = $('doneSearch').value.trim();
    doneState.page = 1;
    loadDone();
  });
  $('donePrev').addEventListener('click', () => { doneState.page = Math.max(1, doneState.page - 1); loadDone(); });
  $('doneNext').addEventListener('click', () => { doneState.page += 1; loadDone(); });

  $('themeToggle').addEventListener('click', () => {
    const isDark = document.body.classList.contains('force-dark');
    setTheme(isDark ? 'light' : 'dark');
  });

  initTheme();
</script>
</body>
</html>
