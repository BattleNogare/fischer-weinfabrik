<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fischer Weinfabrik Â· AuftrÃ¤ge</title>
  <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/BattleNogare/h-h_weinfabrik/main/fischer_weinfabrik_logo.png">

  <style>
    :root{
      --bg0:#07080b;
      --bg1:#0b0d12;
      --card: rgba(255,255,255,.05);
      --card2: rgba(255,255,255,.035);
      --border: rgba(255,255,255,.09);
      --text:#e8ebf2;
      --muted:#a7afbf;
      --accent:#e11d48;
      --accent2:#fb7185;
      --shadow: 0 18px 45px rgba(0,0,0,.45);
      --shadow2: 0 10px 22px rgba(0,0,0,.35);
      --radius: 16px;
      --radius2: 12px;
      --focus: 0 0 0 4px rgba(225,29,72,.22);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color: var(--text);
      background:
        radial-gradient(1200px 700px at 12% 10%, rgba(225,29,72,.18), transparent 55%),
        radial-gradient(900px 520px at 85% 18%, rgba(225,29,72,.09), transparent 52%),
        radial-gradient(700px 500px at 55% 95%, rgba(251,113,133,.08), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .bg-noise{
      position: fixed;
      inset: 0;
      pointer-events:none;
      opacity: .08;
      background-image:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.55'/%3E%3C/svg%3E");
      mix-blend-mode: overlay;
    }

    .app{
      width: min(1100px, 92vw);
      margin: 26px auto 44px;
    }

    /* Topbar */
    .topbar{
      position: sticky;
      top: 16px;
      z-index: 20;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 14px;
      padding: 12px 14px;
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.035));
      border: 1px solid var(--border);
      box-shadow: var(--shadow2);
      backdrop-filter: blur(12px);
    }

    .brand{
      display:flex; align-items:center; gap:10px;
      min-width: 240px;
    }
    .brand img{
      width: 34px; height:34px;
      border-radius: 11px;
      padding: 6px;
      background: rgba(255,255,255,.045);
      border: 1px solid rgba(255,255,255,.10);
    }
    .brand-title{ display:flex; flex-direction:column; line-height:1.1; }
    .brand-title b{ font-size: 14px; letter-spacing:.2px; }
    .brand-title span{ font-size: 11px; color: var(--muted); }

    .tabs{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
      justify-content:center;
    }
    .tab{
      appearance:none;
      border: 1px solid transparent;
      background: transparent;
      color: var(--muted);
      padding: 9px 12px;
      border-radius: 999px;
      cursor:pointer;
      font-weight: 750;
      transition: background .15s ease, border-color .15s ease, transform .08s ease, color .15s ease;
      display:flex; gap:8px; align-items:center;
      white-space:nowrap;
    }
    .tab:hover{
      transform: translateY(-1px);
      background: rgba(255,255,255,.04);
      border-color: rgba(255,255,255,.08);
      color: var(--text);
    }
    .tab.active{
      background: rgba(225,29,72,.16);
      border-color: rgba(225,29,72,.35);
      color: var(--text);
      box-shadow: 0 0 0 4px rgba(225,29,72,.12);
    }
    .dot{
      width:8px; height:8px; border-radius:999px;
      background: var(--accent);
      box-shadow: 0 0 0 3px rgba(225,29,72,.14);
    }

    .actions{
      display:flex; align-items:center; gap:10px; justify-content:flex-end;
      min-width: 240px;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.09);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      font-size: 12px;
      white-space:nowrap;
    }
    .btn{
      appearance:none;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding: 9px 10px;
      border-radius: 12px;
      cursor:pointer;
      font-weight: 760;
      transition: transform .08s ease, border-color .15s ease, background .15s ease;
      display:inline-flex; align-items:center; gap:8px;
    }
    .btn:hover{
      transform: translateY(-1px);
      background: rgba(255,255,255,.055);
      border-color: rgba(255,255,255,.14);
    }
    .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; }
    .btn-primary{
      border-color: rgba(225,29,72,.40);
      background: linear-gradient(180deg, rgba(225,29,72,.26), rgba(225,29,72,.12));
    }
    .btn-danger{
      border-color: rgba(239,68,68,.45);
      background: linear-gradient(180deg, rgba(239,68,68,.20), rgba(239,68,68,.10));
    }

    /* Cards */
    .grid{ margin-top: 14px; display:grid; gap: 14px; }
    .card{
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-hd{
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      display:flex; align-items:center; justify-content:space-between; gap: 12px;
    }
    .card-hd h3{
      margin:0;
      font-size: 14px;
      letter-spacing: .2px;
    }
    .card-bd{ padding: 16px; }

    /* Message */
    .msg{
      margin-top: 14px;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.09);
      background: rgba(255,255,255,.03);
      display:none;
      white-space: pre-line;
    }
    .msg.show{ display:block; }
    .msg.ok{ border-color: rgba(34,197,94,.28); }
    .msg.error{ border-color: rgba(239,68,68,.34); }

    /* Form */
    .form{
      display:grid;
      gap: 12px;
      grid-template-columns: 1fr;
      max-width: 720px;
    }
    label{ display:block; font-weight: 800; font-size: 12px; color: var(--muted); }
    input, textarea, select{
      width:100%;
      margin-top: 6px;
      padding: 11px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      color: var(--text);
      outline:none;
      transition: box-shadow .15s ease, border-color .15s ease, background .15s ease;
    }
    textarea{ min-height: 92px; resize: vertical; }
    input:focus, textarea:focus, select:focus{
      box-shadow: var(--focus);
      border-color: rgba(225,29,72,.45);
      background: rgba(0,0,0,.26);
    }
    input[readonly]{ opacity:.9; }

    .muted{ color: var(--muted); font-size: 12px; }

    /* Toolbar / Pagination */
    .toolbar{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      padding: 12px 16px;
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .toolbar input{
      max-width: 360px;
    }
    .pager{ margin-left:auto; display:flex; gap:8px; align-items:center; }

    /* Table */
    .table-wrap{
      max-height: 72vh;
      overflow:auto;
    }
    table{
      width:100%;
      border-collapse: separate;
      border-spacing: 0;
      min-width: 980px;
    }
    thead th{
      position: sticky;
      top: 0;
      z-index: 5;
      background: rgba(10,10,14,.85);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,.08);
      padding: 10px 12px;
      text-align:left;
      font-size: 11px;
      letter-spacing: .12em;
      text-transform: uppercase;
      color: rgba(231,235,242,.75);
    }
    tbody td{
      border-bottom: 1px solid rgba(255,255,255,.06);
      padding: 12px 12px;
      vertical-align: top;
      color: rgba(231,235,242,.92);
    }
    tbody tr:hover td{
      background: rgba(255,255,255,.02);
    }

    .date-cell input[type="date"]{
      padding: 9px 10px;
      border-radius: 12px;
      min-width: 150px;
    }
    .tiny{ padding: 8px 10px; border-radius: 12px; font-weight: 780; }
    .hidden{ display:none !important; }

    /* Small */
    @media (max-width: 980px){
      .topbar{ border-radius: 18px; padding: 12px; }
      .brand, .actions{ min-width:auto; }
      .actions{ flex-wrap:wrap; justify-content:flex-end; }
      table{ min-width: 920px; }
    }
  </style>
</head>

<body>
  <div class="bg-noise"></div>

  <div class="app">
    <div class="topbar">
      <div class="brand">
        <img alt="Logo" src="https://raw.githubusercontent.com/BattleNogare/h-h_weinfabrik/main/fischer_weinfabrik_logo.png">
        <div class="brand-title">
          <b>Fischer Weinfabrik Â· AuftrÃ¤ge</b>
          <span>Minimal UI Â· Rot Akzent Â· Supabase</span>
        </div>
      </div>

      <div class="tabs">
        <button id="tab-create" class="tab active"><span class="dot"></span>Auftrag erstellen</button>
        <button id="tab-open" class="tab"><span class="dot"></span>Offene AuftrÃ¤ge</button>
        <button id="tab-done" class="tab"><span class="dot"></span>Fertige AuftrÃ¤ge</button>
      </div>

      <div class="actions">
        <span id="syncPill" class="pill">Sync: â€“</span>
        <button id="btnReload" class="btn tiny">â†» Neu laden</button>
      </div>
    </div>

    <div id="msg" class="msg"></div>

    <div class="grid">
      <section id="view-create" class="card">
        <div class="card-hd">
          <h3>Auftrag erstellen</h3>
          <span class="pill">Kosten: auto Â· â‚¬</span>
        </div>
        <div class="card-bd">
          <div class="form">
            <div><label>Kunde*<input id="fKunde" type="text" required /></label></div>
            <div><label>Mitarbeiter*<input id="fMitarbeiter" type="text" required /></label></div>
            <div><label>Anzahl FÃ¤sser*<input id="fAnzahl" type="number" min="0" step="1" required /></label></div>
            <div><label>Prozent* (1â€“100)<input id="fProzent" type="number" min="1" max="100" step="1" required /></label></div>
            <div><label>Kosten (automatisch)<input id="fKosten" type="text" readonly /></label></div>
            <div><label>Info<textarea id="fInfo" rows="3"></textarea></label></div>
          </div>

          <div style="margin-top: 14px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <button id="btnCreate" class="btn btn-primary">ðŸ’¾ Speichern</button>
            <span class="muted">AuftragsDatum wird automatisch gesetzt Â· Erhalten startet mit â€žNeinâ€œ</span>
          </div>
        </div>
      </section>

      <section id="view-open" class="card hidden">
        <div class="card-hd">
          <h3>Offene AuftrÃ¤ge</h3>
          <span class="pill">Suche: Kunde/Mitarbeiter</span>
        </div>

        <div class="toolbar">
          <input id="openSearch" type="text" placeholder="Suche Kunde/Mitarbeiterâ€¦" />
          <div class="pager">
            <button id="openPrev" class="btn tiny">â—€</button>
            <span id="openPageInfo" class="pill"></span>
            <button id="openNext" class="btn tiny">â–¶</button>
          </div>
        </div>

        <div id="openTableWrap" class="table-wrap"></div>
      </section>

      <section id="view-done" class="card hidden">
        <div class="card-hd">
          <h3>Fertige AuftrÃ¤ge</h3>
          <span class="pill">LÃ¶schen mÃ¶glich</span>
        </div>

        <div class="toolbar">
          <input id="doneSearch" type="text" placeholder="Suche Kunde/Mitarbeiterâ€¦" />
          <div class="pager">
            <button id="donePrev" class="btn tiny">â—€</button>
            <span id="donePageInfo" class="pill"></span>
            <button id="doneNext" class="btn tiny">â–¶</button>
          </div>
        </div>

        <div id="doneTableWrap" class="table-wrap"></div>
      </section>
    </div>
  </div>

<script>
/** =========================
 * CONFIG
 * ========================= */
const API_URL = 'https://mtyaczfezilcnllnwgqq.supabase.co/functions/v1/auftraege-api';
const PAGE_SIZE = 50;
const DEBUG = false;

/** =========================
 * Helpers
 * ========================= */
const $ = (id) => document.getElementById(id);
function log(...args){ if (DEBUG) console.log('[UI]', ...args); }

function showMsg(type, text) {
  const el = $('msg');
  el.className = 'msg show ' + (type === 'error' ? 'error' : 'ok');
  el.textContent = text;
  clearTimeout(showMsg._t);
  showMsg._t = setTimeout(() => { el.className = 'msg'; el.textContent=''; }, 5200);
}

function setTab(tab) {
  const tabs = ['create','open','done'];
  for (const t of tabs) {
    $('tab-' + t).classList.toggle('active', t === tab);
    $('view-' + t).classList.toggle('hidden', t !== tab);
  }
  if (tab === 'open') { loadAndRenderOpen().catch(e => showMsg('error', e.message)); }
  if (tab === 'done') { loadAndRenderDone().catch(e => showMsg('error', e.message)); }
}

function todayISO() {
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd}`;
}
const TODAY_MIN = todayISO();
function isDateBeforeToday(dateStr) { return !!dateStr && dateStr < TODAY_MIN; }

function toInt(v){
  const n = Math.trunc(Number(String(v ?? '').replace(',', '.')));
  return Number.isFinite(n) ? n : 0;
}
function escapeHtml(s) {
  return String(s ?? '')
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#039;');
}
function computeKosten(anzahl, prozent) {
  const a = Number(anzahl);
  const p = Number(prozent);
  if (!Number.isFinite(a) || !Number.isFinite(p)) return '';
  const val = (a * 8 * 1299) * (p / 100);
  return Math.round(val).toLocaleString('de-DE') + ' â‚¬';
}
function moneyEUR(n) {
  const v = Number(n);
  if (!Number.isFinite(v)) return '';
  return Math.round(v).toLocaleString('de-DE') + ' â‚¬';
}

/** =========================
 * API client (OPEN)
 * ========================= */
async function apiFetch(path, { method="GET", body=null } = {}) {
  const url = API_URL + path;
  const headers = {};
  const init = { method, headers };

  if (body !== null) {
    headers["Content-Type"] = "application/json";
    init.body = JSON.stringify(body);
  }

  log('FETCH', method, url, body || '');
  const res = await fetch(url, init);

  let json;
  try { json = await res.json(); }
  catch { throw new Error("Antwort ist kein JSON (Server/CORS)."); }

  if (!res.ok || !json.ok) {
    throw new Error((json && json.error ? json.error : 'Request failed') + (json && json.detail ? `\n${json.detail}` : ''));
  }
  return json;
}

async function apiList(status, limit=1000, offset=0){
  return apiFetch(`?action=list&status=${encodeURIComponent(status)}&limit=${limit}&offset=${offset}`);
}
async function apiCreate(payload){
  return apiFetch(`?action=create`, { method:"POST", body: payload });
}
async function apiPatch(payload){
  return apiFetch(`?action=patch`, { method:"POST", body: payload });
}
async function apiDelete(id){
  return apiFetch(`?action=delete`, { method:"POST", body: { id } });
}

/** =========================
 * Data + pagination/search
 * ========================= */
let allOpen = [];
let allDone = [];
let lastSync = null;

let openState = { page: 1, search: '' };
let doneState = { page: 1, search: '' };

function applySearchAndPage(rows, state) {
  const q = String(state.search || '').trim().toLowerCase();
  let filtered = rows;

  if (q) {
    filtered = rows.filter(r =>
      String(r.kunde || '').toLowerCase().includes(q) ||
      String(r.mitarbeiter || '').toLowerCase().includes(q)
    );
  }

  filtered.sort((a,b) => (a.id||0) - (b.id||0));

  const total = filtered.length;
  const start = (state.page - 1) * PAGE_SIZE;
  const items = filtered.slice(start, start + PAGE_SIZE);
  return { total, items };
}

function setSyncPill(){
  if (!lastSync) $('syncPill').textContent = 'Sync: â€“';
  else $('syncPill').textContent = 'Sync: ' + lastSync.toLocaleString('de-DE');
}

async function loadAndRenderOpen(){
  const out = await apiList('open', 1000, 0);
  allOpen = out.items || [];
  lastSync = new Date();
  setSyncPill();
  renderOpen();
}
async function loadAndRenderDone(){
  const out = await apiList('done', 1000, 0);
  allDone = out.items || [];
  lastSync = new Date();
  setSyncPill();
  renderDone();
}
async function loadAllForReload(){
  const [o,d] = await Promise.all([apiList('open', 1000, 0), apiList('done', 1000, 0)]);
  allOpen = o.items || [];
  allDone = d.items || [];
  lastSync = new Date();
  setSyncPill();
  if ($('tab-open').classList.contains('active')) renderOpen();
  if ($('tab-done').classList.contains('active')) renderDone();
}

/** =========================
 * UI render
 * ========================= */
function renderOpen() {
  const { total, items } = applySearchAndPage(allOpen, openState);

  $('openPageInfo').textContent = `Seite ${openState.page} Â· ${total} Treffer`;
  $('openPrev').disabled = openState.page <= 1;
  $('openNext').disabled = (openState.page * PAGE_SIZE) >= total;

  const wrap = $('openTableWrap');
  if (!items.length) { wrap.innerHTML = '<div class="card-bd"><div class="muted">Keine offenen AuftrÃ¤ge gefunden.</div></div>'; return; }

  wrap.innerHTML = `
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Kunde</th>
          <th>Mitarbeiter</th>
          <th>Anzahl</th>
          <th>Prozent</th>
          <th>Kosten</th>
          <th>AbholDatum</th>
          <th>Erhalten?</th>
          <th>Info</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        ${items.map(r => {
          const abhol = (r.abhol_datum || '') ? String(r.abhol_datum).slice(0,10) : '';
          return `
            <tr>
              <td style="font-family:var(--mono);">${r.id}</td>
              <td>${escapeHtml(r.kunde)}</td>
              <td>${escapeHtml(r.mitarbeiter)}</td>
              <td>${toInt(r.anzahl)}</td>
              <td>${toInt(r.prozent)}</td>
              <td>${moneyEUR(r.kosten)}</td>
              <td class="date-cell">
                <input type="date" min="${TODAY_MIN}" data-id="${r.id}" class="open-abhol" value="${escapeHtml(abhol)}">
              </td>
              <td>
                <select data-id="${r.id}" class="open-erhalten">
                  <option value="0" selected>Nein</option>
                  <option value="1">Ja</option>
                </select>
                <div class="muted">Ja nur mit AbholDatum</div>
              </td>
              <td><textarea data-id="${r.id}" class="open-info" rows="2">${escapeHtml(r.info || '')}</textarea></td>
              <td><button data-id="${r.id}" class="btn tiny btn-primary open-save">Speichern</button></td>
            </tr>
          `;
        }).join('')}
      </tbody>
    </table>
  `;

  wrap.querySelectorAll('.open-save').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = Number(btn.getAttribute('data-id'));
      const info = wrap.querySelector('.open-info[data-id="' + id + '"]').value;
      const erhalten = wrap.querySelector('.open-erhalten[data-id="' + id + '"]').value;
      const abhol = wrap.querySelector('.open-abhol[data-id="' + id + '"]').value;

      if (abhol && isDateBeforeToday(abhol)) { showMsg('error', 'AbholDatum darf nicht in der Vergangenheit liegen.'); return; }
      if (erhalten === '1' && !abhol) { showMsg('error', 'Bitte zuerst ein AbholDatum auswÃ¤hlen (Pflicht), bevor "Erhalten = Ja" gesetzt wird.'); return; }

      btn.disabled = true;
      const old = btn.textContent;
      btn.textContent = 'Speichertâ€¦';

      try {
        await apiPatch({
          id,
          info,
          abhol_datum: abhol || null,
          erhalten: (erhalten === '1')
        });
        showMsg('ok', 'Gespeichert. ID: ' + id);
        await loadAndRenderOpen();
      } catch (e) {
        showMsg('error', e.message);
      } finally {
        btn.disabled = false;
        btn.textContent = old;
      }
    });
  });
}

function renderDone() {
  const { total, items } = applySearchAndPage(allDone, doneState);

  $('donePageInfo').textContent = `Seite ${doneState.page} Â· ${total} Treffer`;
  $('donePrev').disabled = doneState.page <= 1;
  $('doneNext').disabled = (doneState.page * PAGE_SIZE) >= total;

  const wrap = $('doneTableWrap');
  if (!items.length) { wrap.innerHTML = '<div class="card-bd"><div class="muted">Keine fertigen AuftrÃ¤ge gefunden.</div></div>'; return; }

  wrap.innerHTML = `
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>AuftragsDatum</th>
          <th>Kunde</th>
          <th>Mitarbeiter</th>
          <th>Anzahl</th>
          <th>Prozent</th>
          <th>Kosten</th>
          <th>AbholDatum</th>
          <th>Info</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        ${items.map(r => {
          const auftrags = r.auftrags_datum ? new Date(r.auftrags_datum).toLocaleString('de-DE') : '';
          const abhol = (r.abhol_datum || '') ? String(r.abhol_datum).slice(0,10) : '';
          return `
            <tr>
              <td style="font-family:var(--mono);">${r.id}</td>
              <td>${escapeHtml(auftrags)}</td>
              <td>${escapeHtml(r.kunde)}</td>
              <td>${escapeHtml(r.mitarbeiter)}</td>
              <td>${toInt(r.anzahl)}</td>
              <td>${toInt(r.prozent)}</td>
              <td>${moneyEUR(r.kosten)}</td>
              <td>${escapeHtml(abhol)}</td>
              <td>${escapeHtml(r.info || '')}</td>
              <td><button data-id="${r.id}" class="btn tiny btn-danger done-del">LÃ¶schen</button></td>
            </tr>
          `;
        }).join('')}
      </tbody>
    </table>
  `;

  wrap.querySelectorAll('.done-del').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = Number(btn.getAttribute('data-id'));
      if (!confirm('Auftrag ID ' + id + ' wirklich lÃ¶schen?')) return;

      btn.disabled = true;
      const old = btn.textContent;
      btn.textContent = 'LÃ¶schtâ€¦';

      try {
        await apiDelete(id);
        showMsg('ok', 'GelÃ¶scht. ID: ' + id);
        await loadAndRenderDone();
      } catch (e) {
        showMsg('error', e.message);
      } finally {
        btn.disabled = false;
        btn.textContent = old;
      }
    });
  });
}

/** =========================
 * Create
 * ========================= */
function validateCreateForm() {
  const kunde = $('fKunde').value.trim();
  const mitarbeiter = $('fMitarbeiter').value.trim();
  const anzahl = toInt($('fAnzahl').value);
  const prozent = toInt($('fProzent').value);

  if (!kunde) throw new Error('Kunde ist Pflichtfeld.');
  if (!mitarbeiter) throw new Error('Mitarbeiter ist Pflichtfeld.');
  if (!Number.isInteger(anzahl) || anzahl < 0) throw new Error('Anzahl muss eine nicht-negative Ganzzahl sein.');
  if (!Number.isInteger(prozent) || prozent < 1 || prozent > 100) throw new Error('Prozent muss 1â€“100 (Ganzzahl) sein.');
}

function hookKostenAuto() {
  const recalc = () => { $('fKosten').value = computeKosten($('fAnzahl').value, $('fProzent').value); };
  $('fAnzahl').addEventListener('input', recalc);
  $('fProzent').addEventListener('input', recalc);
  recalc();
}

async function createOrder() {
  const btn = $('btnCreate');
  btn.disabled = true;
  const old = btn.textContent;
  btn.textContent = 'Speichertâ€¦';

  try {
    validateCreateForm();

    const kunde = $('fKunde').value.trim();
    const mitarbeiter = $('fMitarbeiter').value.trim();
    const anzahl = toInt($('fAnzahl').value);
    const prozent = toInt($('fProzent').value);
    const info = $('fInfo').value.trim();

    await apiCreate({ kunde, mitarbeiter, anzahl, prozent, info });

    showMsg('ok', 'Gespeichert.');

    $('fKunde').value = '';
    $('fMitarbeiter').value = '';
    $('fAnzahl').value = '';
    $('fProzent').value = '';
    $('fInfo').value = '';
    $('fKosten').value = '';

    await loadAndRenderOpen();
    setTab('open');

  } catch (e) {
    showMsg('error', e.message);
  } finally {
    btn.disabled = false;
    btn.textContent = old;
  }
}

/** =========================
 * Wire up
 * ========================= */
$('tab-create').addEventListener('click', () => setTab('create'));
$('tab-open').addEventListener('click', () => setTab('open'));
$('tab-done').addEventListener('click', () => setTab('done'));

$('btnCreate').addEventListener('click', createOrder);

$('openSearch').addEventListener('input', () => { openState.search = $('openSearch').value.trim(); openState.page=1; renderOpen(); });
$('openPrev').addEventListener('click', () => { openState.page=Math.max(1, openState.page-1); renderOpen(); });
$('openNext').addEventListener('click', () => { openState.page+=1; renderOpen(); });

$('doneSearch').addEventListener('input', () => { doneState.search = $('doneSearch').value.trim(); doneState.page=1; renderDone(); });
$('donePrev').addEventListener('click', () => { doneState.page=Math.max(1, doneState.page-1); renderDone(); });
$('doneNext').addEventListener('click', () => { doneState.page+=1; renderDone(); });

$('btnReload').addEventListener('click', async () => {
  try {
    $('btnReload').disabled = true;
    $('syncPill').textContent = 'Sync: aktualisiertâ€¦';
    await loadAllForReload();
    showMsg('ok', 'Neu geladen.');
  } catch (e) {
    showMsg('error', e.message);
  } finally {
    $('btnReload').disabled = false;
  }
});

hookKostenAuto();

// Boot
(async function init(){
  try{
    await loadAllForReload();
    setTab('create');
  } catch(e){
    showMsg('error', e.message);
  }
})();
</script>
</body>
</html>
